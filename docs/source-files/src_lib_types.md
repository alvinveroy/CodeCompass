# `src/lib/types.ts`

## Overview

The `src/lib/types.ts` module defines various TypeScript interfaces and Zod schemas used throughout the CodeCompass application. These types and schemas ensure data consistency and provide validation for inputs and outputs of different modules, especially for MCP (Model-Context-Protocol) tool parameters and API responses.

## Zod Schemas

Zod schemas are used for runtime validation of data structures, particularly for parameters passed to MCP tools.

### `SearchCodeSchema`

-   **Purpose**: Validates parameters for the `search_code` tool.
-   **Schema**:
    ```typescript
    z.object({ 
      query: z.string().min(1, "Query is required"),
      sessionId: z.string().optional()
    })
    ```
-   **Fields**:
    -   `query: string`: The search query (required, non-empty).
    -   `sessionId?: string`: Optional session ID.

### `GenerateSuggestionSchema`

-   **Purpose**: Validates parameters for the `generate_suggestion` tool.
-   **Schema**:
    ```typescript
    z.object({
      query: z.string().min(1, "Query is required").optional(),
      prompt: z.string().min(1, "Prompt is required").optional(),
      sessionId: z.string().optional()
    }).transform((data) => ({ // Transforms to ensure 'query' is always present
      query: data.query || data.prompt || "",
      sessionId: data.sessionId
    })).refine(data => data.query.length > 0, { // Ensures either original query or prompt was non-empty
      message: "Either query or prompt must be a non-empty string",
      path: ["query"],
    })
    ```
-   **Fields**:
    -   `query?: string`: The primary query or topic for the suggestion (optional).
    -   `prompt?: string`: An alternative way to specify the query (optional).
    -   `sessionId?: string`: Optional session ID.
-   **Transformation**: The schema transforms the input so that `data.query` is populated from `data.prompt` if `data.query` is not provided.
-   **Refinement**: It then refines the transformed data to ensure that the resulting `query` field is non-empty.

### `GetRepositoryContextSchema`

-   **Purpose**: Validates parameters for the `get_repository_context` tool.
-   **Schema**:
    ```typescript
    z.object({ 
      query: z.string().min(1, "Query is required"),
      sessionId: z.string().optional()
    }).or(
      z.string().min(1, "Query is required").transform(query => ({ query })) // Allows a raw string as input
    )
    ```
-   **Fields**:
    -   `query: string`: The query for which repository context is needed (required, non-empty).
    -   `sessionId?: string`: Optional session ID.
-   **Alternative**: Accepts a plain string, which is then transformed into an object `{ query: string }`.

### `AgentQuerySchema`

-   **Purpose**: Validates parameters for the `agent_query` tool.
-   **Schema**:
    ```typescript
    z.object({
      query: z.string().min(1, "Query is required"),
      sessionId: z.string().optional()
    })
    ```
-   **Fields**:
    -   `query: string`: The user's query for the agent (required, non-empty).
    -   `sessionId?: string`: Optional session ID.

### `AgentStepSchema`

-   **Purpose**: Validates the structure of a single step taken by an agent.
-   **Schema**:
    ```typescript
    z.object({
      tool: z.string(),
      input: z.unknown(),
      output: z.unknown(),
      reasoning: z.string(),
    })
    ```
-   **Fields**:
    -   `tool: string`: Name of the tool used.
    -   `input: unknown`: Parameters passed to the tool.
    -   `output: unknown`: Result from the tool.
    -   `reasoning: string`: Agent's reasoning for this step.

### `AgentStateSchema`

-   **Purpose**: Validates the overall state of an agent's execution.
-   **Schema**:
    ```typescript
    z.object({
      sessionId: z.string(),
      query: z.string(),
      planText: z.string().optional(),
      steps: z.array(AgentStepSchema),
      context: z.array(z.unknown()),
      finalResponse: z.string().optional(),
      isComplete: z.boolean(),
    })
    ```
-   **Fields**:
    -   `sessionId: string`: Session ID.
    -   `query: string`: Initial user query.
    -   `planText?: string`: Raw plan generated by the LLM (optional).
    -   `steps: AgentStep[]`: Array of agent steps.
    -   `context: unknown[]`: Accumulated context.
    -   `finalResponse?: string`: Final response from the agent (optional).
    -   `isComplete: boolean`: Flag indicating if processing is complete.

## TypeScript Interfaces

These interfaces define the shape of various data objects used in the application.

### `OllamaEmbeddingResponse`

-   **Purpose**: Represents the expected response structure from Ollama's embedding API.
-   **Fields**:
    -   `embedding: number[]`: An array of numbers representing the vector embedding.

### `OllamaGenerateResponse`

-   **Purpose**: Represents the expected response structure from Ollama's text generation API.
-   **Fields**:
    -   `response: string`: The generated text.

### `QdrantPoint`

-   **Purpose**: Defines the structure of a point to be stored in Qdrant.
-   **Fields**:
    -   `id: string`: Unique identifier for the point.
    -   `vector: number[]`: The vector embedding.
    -   `payload: object`:
        -   `filepath: string`: Path to the source file.
        -   `content: string`: The content that was embedded.
        -   `last_modified: string`: ISO string of the last modification date.

### `QdrantSearchResult`

-   **Purpose**: Defines the structure of a search result item from Qdrant.
-   **Fields**:
    -   `id: string | number`: ID of the matching point.
    -   `payload: object`:
        -   `content: string`: The indexed content.
        -   `filepath: string`: Path to the source file.
        -   `last_modified: string`: Last modification date.
    -   `score: number`: Relevance score of the result.

### `AgentStep`

-   **Purpose**: Represents a single step in an agent's execution flow.
-   **Fields**:
    -   `tool: string`: Name of the tool executed.
    -   `input: unknown`: Input parameters for the tool.
    -   `output: unknown`: Output/result from the tool.
    -   `reasoning: string`: The agent's reasoning behind this step.

### `AgentState`

-   **Purpose**: Represents the complete state of an agent's interaction.
-   **Fields**:
    -   `sessionId: string`: Unique session identifier.
    -   `query: string`: The initial user query.
    -   `planText?: string`: The raw plan text generated by the LLM (optional).
    -   `steps: AgentStep[]`: Array of executed agent steps.
    -   `context: unknown[]`: Accumulated information/context from tool outputs.
    -   `finalResponse?: string`: The final synthesized response from the agent (optional).
    -   `isComplete: boolean`: Flag indicating if the agent has completed its processing.

### `AgentInitialQueryResponse`

-   **Purpose**: Defines the response structure from the `SuggestionPlanner.initiateAgentQuery` method.
-   **Fields**:
    -   `sessionId: string`: Session ID.
    -   `status: "COMPLETED" | "ERROR"`: Outcome status.
    -   `message: string`: Human-readable message about the outcome.
    -   `generatedPlanText?: string`: The raw plan text from the LLM (optional).
    -   `agentState: AgentState`: The complete, updated agent state.

### `DetailedQdrantSearchResult`

-   **Purpose**: Provides a more comprehensive structure for Qdrant search results, including optional fields that might be returned by the Qdrant client.
-   **Fields**:
    -   `id: string | number`: ID of the point.
    -   `score: number`: Relevance score.
    -   `payload: object`:
        -   `filepath: string`: Path to the source file.
        -   `content: string`: Indexed content.
        -   `last_modified: string`: Last modification date.
        -   `[key: string]: unknown`: Allows for other arbitrary payload fields.
    -   `version?: number`: Version of the point (optional).
    -   `vector?: number[] | Record<string, unknown> | number[][] | null`: Vector data (optional).
    -   `shard_key?: string`: Shard key if applicable (optional).
    -   `order_value?: number`: Order value if applicable (optional).

## Removed Types/Schemas

-   `FeedbackSchema`: This Zod schema was previously defined but has been removed.
-   `AgentStepExecutionResponse`: This interface was previously defined but has been removed.
